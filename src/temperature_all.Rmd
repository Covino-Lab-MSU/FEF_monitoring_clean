---
title: "temp_clean"
author: "Lauren Kremer"
date: "11/21/2021"
output: html_document
---

Script for CO2 data from OM-CP-VOLT101A Voltage Data Logger

1) removing bad data
2) adjusting data for shifts 

Requires CO2 raw data


```{r setup, include=FALSE}

library(tidyverse)
library(lubridate)
library(xts)
library(dygraphs)
library(ggrepel)
library(knitr)
library(plotly)

source('functions/co2functions.R') #load helper functions
```

```{r}
opn_concat_co <- function(interfiles, location, site) {
  file_path <- paste(getwd(),interfiles,location,site, sep='/')
  path_list <- paste(file_path, list.files(file_path), sep= '/')
  data <- lapply(path_list, function(x) {
    dat <- read.table(x, skip = 0, header = TRUE, sep = ",", row.names = NULL, as.is = TRUE)
    # for each item in path list, grab the device number
    #dat$logr_no <- unlist(strsplit(x, "_"))[9]
    return(dat)
  })
  combined.data <- do.call(rbind, data)
  #drops <- c("formatted_datetime")
  combined.data <- combined.data %>%
    mutate(datetime = lubridate::dmy_hm(datetime))%>%
    arrange(datetime)%>%
    #select(-one_of(drops))%>%
    distinct()%>%
    return(combined.data)
}
```

#Clean By Site

###Load data with opn_concat
## requires same date format across all spreadsheets. I've been adding
the column formatted_dataetime in excel with:
 1. for dd/mm/yyyy hh:mm:ss '=REPLACE(MID(B2,4,20),4,0,LEFT(B2,3))+0'
 2. for d/m/yy hh:mm '=TEXT(VALUE(B1916),"dd/mm/yyyy hh:mm")'
```{r}

interfiles <- 'data/2_formatted_stage_caprod'
# possible locations: 'dh', 'est_louis', 'fool', 'lexen'
location<- 'fool'
site <- 'fool2'
#site_list <- list()

for (i in location_path_list) {
  site <- list.files(i, full.names = TRUE)
  site_list[[length(site_list)+1]] <- paste(getwd(), site, sep = '/')
}

site_list <- unlist(site_list)


#df_list <- list()
#for (i in site_list) {
#  location <- unlist(str_split(i, pattern = '/'))[9]
#  site <- unlist(str_split(i, pattern = '/'))[10]
#  conc_df <- opn_concat(interfiles, location, site)
#  df_list[[length(df_list)+1]] <- conc_df
#}
  

```

```{r}

fool2_temp_raw <- opn_concat_co(interfiles, location, site)


```


```{r}
#quick plot of stage
fool2_temp_check_plot <- ggplot(temp_raw, aes(datetime,wtemp_a_1))+
  geom_line()

ggplotly(temp_check_plot)
```

###Create complete timeseries that includes any missing datetimes
```{r}
#check if collection interval is consistent in dataset. Code as written only handles one interval but can be modified if interval was changed. 
checkTimeSteps()

ts_interval<- temp_raw$datetime[2] - temp_raw$datetime[1]

##round datetime to nearest whole interval
temp_raw <- temp_raw%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(temp_raw$datetime[1], temp_raw$datetime[length(temp_raw$datetime)], by=ts_interval))
temp_raw <- full_join(full_ts,temp_raw)


#identify missing timesteps:
miss_ts <- filter(temp_raw, is.na(temp_ppm))%>%
  pull(datetime)
length(miss_ts)
```


1) Plot battery for quick checks
2) Add ID column to use for identifying bad data
3) Plot raw data with flag if raw level changes by more than x%. 

```{r}
#check battery
DyBatt()

```




###save
```{r}
temp_raw$datetime <- format(temp_raw$datetime, usetz=TRUE)

interfiles <- '3_cleaned'
file_path <- paste(getwd(),interfiles,location,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(temp_raw, file=paste0(file_path, '_clean.csv'))


```


```{r}
opn_cleaned <- function(interfiles, location) {
  file_path <- paste(getwd(),interfiles,location, sep='/')
  path_list <- paste(file_path, list.files(file_path), sep= '/')
  data <- lapply(path_list, function(x) {
    dat <- read.table(x, skip = 0, header = TRUE, sep = ",", row.names = NULL, as.is = TRUE)
    # for each item in path list, grab the site nname
    sitecsv <- unlist(strsplit(x, "/"))[12]
    dat$site <- unlist(strsplit(sitecsv, "_"))[1]
    return(dat)
  })
  combined.data <- do.call(rbind, data)
  #drops <- c("formatted_datetime")
  combined.data <- combined.data %>%
    #mutate(datetime = strptime(datetime, format = '%Y-%m-%dT%H:%M:%OS%z'))%>%
    mutate(datetime = lubridate::as_datetime(datetime))%>%
    arrange(site)%>%
    #select(-one_of(drops))%>%
    #distinct()%>%
    return(combined.data)
}

```

```{r}
interfiles <- '3_cleaned'
# possible locations: 'dh', 'est_louis', 'fool', 'lexen'
location <- 'fool'
temp_cleaned <- opn_cleaned(interfiles, location)

str(temp_cleaned)

temp_cleaned <- subset(temp_cleaned, datetime <= '2021-07-23 20:00:00')
                      
```

```{r}
co2plot <- ggplot(data = temp_cleaned, aes(x=datetime, y=temp_ppm, color = site)) + 
  geom_line() + 
  xlab('Date') +
  ylab('CO2 (ppm)') 



ggplotly(co2plot)
```


