---
title: "HOBO water level logger data cleaning - Fool Creek "
author: "Adapted for FEF by LKremer"
date: "`r format(Sys.Date())`"
output:
  html_document:
    theme: flatly
    highlight: breezedark
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

This script is used to clean water level data from HOBO water level loggers (U20L-04)
designed for surface water level measurements.
Cleaning and QA/QC steps include: 

1) removing bad data
2) converting stage to water depth
3) adjusting data for shifts in logger position
4) checking results against manual measurements.

Inputs are water level logger raw data (periodically downloaded .csvs) and a manual measurement spreadsheet specific to the site being reviewed

Setup

Package and function import from .R script

```{r setup, echo=TRUE, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(message=F, warning=F, error=F, 
                      comment=NA, cache=T, R.options=list(width=220), 
                      fig.align='center', out.width='75%', fig.asp=.75)

pkgTest <- function(x)
{
  if (x %in% rownames(installed.packages()) == FALSE) {
    install.packages(x, dependencies= TRUE)
  }
  library(x, character.only = TRUE)
}

#if(!require(devtools)) install.packages("devtools")
#devtools::install_github("kassambara/gg1pubr")

# Make a vector of the packages you need
neededPackages <- c('ezknitr', 'tidyverse', 'lubridate', 'xts', 'dygraphs', 'ggrepel','knitr', 'plotly', 'ggpubr') #tools for plot titles 

# For every package in the vector, apply your pkgTest function
for (package in neededPackages){pkgTest(package)}

source('./functions/ws_transect_pressure_stageFunctions.R') #load helper functions

```

Additional functions
Functions that open and concatenate formatted data files

```{r functions20, include=FALSE}

# A universal function to open all water level logger data for a 'site' to a list of dataframes
opn_as_dflist <- function(interfiles, year, watershed, site) {
   file_path <- paste(getwd(), interfiles, year, watershed, site, sep='/')
   path_list <- paste(file_path, list.files(file_path), sep= '/')
   data <- lapply(path_list, function(x) {
      dat <- read.table(x, skip = 1, header = TRUE, sep = ",", row.names = NULL, as.is = TRUE)
      dat <- head(dat, -3)
      dat <- dat[, 2:4]
      colnames(dat) <- c('datetime', 'pressure_kPa', 'temperature_C')
      # for each item in path list, grab the cap_rod number
      dat$logger_no <- as.factor(unlist(strsplit(x, "_"))[8])
      dat$trans_loc <- as.factor(unlist(strsplit(x, "_"))[7])
      return(dat)
   })
}

concat <- function(data) {
  combined.data <- do.call(rbind, data) #combine datasets as stacked rows
  combined.data <- combined.data %>%
    mutate(datetime = lubridate::mdy_hm(datetime)) %>% #convert to datetime
    arrange(datetime) %>% 
    drop_na() %>%
    dplyr::distinct() 
   return(combined.data)
}

# load manual measurements
interfiles <- 'formatted_data/manual_measurements/2020/manual_wells_waterlevel_meas.csv'
file_path <- paste(getwd(),interfiles, sep='/')

manualMeas <- read.table(file_path, skip=0, header=TRUE, sep=",", row.names = NULL, as.is = TRUE)

```

# {.tabset .tabset-fade}

## 2020 {.tabset .tabset-fade}

### Fool1 {.tabset .tabset-fade}

```{r importfc1_20, include=FALSE}

interfiles <- 'formatted_data/stage_pressure'
year <- 2020
watershed<- 'fool'
site <- 'fc1'
cap.site.label <- 'Fool 1'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))


# load precip data
interfiles <- 'formatted_data/usfs_precip/fool1_lower_met_wy19_wy21.csv'
file_path <- paste(getwd(), interfiles, sep='/')

precip <- read.table(file_path, skip=0, header=TRUE, sep=",", row.names = NULL, as.is = TRUE) %>%
  mutate(datetime = mdy_hm(datetime)) %>%
  filter(datetime <= max(press_raw$datetime)) %>%
  filter(datetime >= min(press_raw$datetime))

#merge precip data w/pressure
press_raw <- press_raw %>%
  merge(., precip, by = 'datetime', all=T) %>%
  mutate(precip_mm = as.numeric(X10min_PPT_mm))
```

Quick raw plot of point data

```{r plot1fc1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

```{r dfsplit_fc1_20}
# Subset based on logger location within the transect
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]]) 
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc1_atms20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  rowid_to_column(var='ID') %>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_atms20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)
 
```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```

```{r chktempfc1_atms20, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE}

#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_atms20, fig.align = "center", fig.cap =  paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atmospheric data from ", cap.site.label, " ", year, " with flags where stage changes by more than 5% in a single timestep. No flags identified in raw atmospheric data.", sep = ''), echo=FALSE}

#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, max=max(press_raw_atms$pressure_kPa)+1, min=min(press_raw_atms$pressure_kPa)-1, flag='TRUE')
```

```{r}
DyRawPP(press_raw_atms)
                       #,threshold = 0.05, max=max(press_raw_atms$pressure_kPa)+1, min=min(press_raw_atms$pressure_kPa)-1)

```

3) Manually identify points to be removed or corrected using the flagged plot (no corrections made for FC1 2020 atmospheric data)

```{r badidfc1_atms20}
# no corrections made for this atmospheric logger
bad_id_fc1_atms20 <-  c(0)

vert_correction_fc1_atms20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_atms20, include=FALSE}  
bad_id <- bad_id_fc1_atms20
vert_correction <- vert_correction_fc1_atms20
```

4) Vertical adjustments

```{r vertcorrectfc1_atms20}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc1_20, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc1atms_20}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1atms_20 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatlw1_fc1_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>% #add an ID no to each row
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) # kPa range 0-145, factory calibrated 69kPa to 145 kPa, range at 10,000ft 0 to 7m or 0 to 4m below 10,000 plus 1.6cm for logger sensor height
 
#water level (h) is given by h=(P-Pr)/(rho * g) where P is the pressure measured by the sensor in the water, Pr is the pressure measured by the reference sensor (atmospheric pressure), rho is the density of the water in the stream, and g is the acceleration due to gravity.

#https://www.onsetcomp.com/files/manual_pdfs/17153-G%20U20L%20Manual.pdf
```

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc1_lw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_lw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
 
```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

```{r chktempfc1_lw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw ", abbr, " data from ", cap.site.label, long_nm, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE', max = max(stage_well$pressure_kPa)+ 10, min = min(stage_well$pressure_kPa) )
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, long_nm, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}
#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_lw1_20}

bad_id_fc1_well20 <-  c(2034:2050,6935 )

vert_correction_fc1_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_lw1_20, include=FALSE}  
bad_id <- bad_id_fc1_well20
vert_correction <- vert_correction_fc1_well20
```

3) Vertical adjustments

```{r vertcorrectfc1_lw1_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 30) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_lw1_20, fig.align = "center", fig.cap = "Figure 3.a: Same as above but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_lw1_20}
manMeas <- manualMeas  %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_lw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

# am not using this until cross-year comparison
depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_lw1_20,, fig.align = "center", fig.cap = "Figure4.2020.FC1.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset)

```

##### Manual measurements

```{r plot7fc1_lw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_lw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_lw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1lw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc1_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc1_lw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_lw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```
 
```{r chktempfc1_lw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, long_nm, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

DyRawPressure(df=stage_well,threshold = 0.05)
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, long_nm, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_lw2_20}

bad_id_fc1_well20 <-  c(2036:2115)

# well was pumped and logger downloaded on 8/12/20. Well was recharged after ~14hours. No other pump or download was recorded.

vert_correction_fc1_well20 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_lw2_20, include=FALSE}  
bad_id <- bad_id_fc1_well20
vert_correction <- vert_correction_fc1_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_lw2_20}

#function to make vertical correction and interpolate between missing values 
stage_adj <- AdjStage(df=stage_well, maxgap=80) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 75) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_lw2_20, fig.align = "center", fig.cap = "Figure 3.a: Same as above but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_lw2_20}

manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_lw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_lw2_20,, fig.align = "center", fig.cap = "Figure4.2020.FC1.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset)

```

##### Manual measurements

```{r plot7fc1_lw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_lw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_lw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1lw2_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc1_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

#water density at 4C = 1, @15.6C = 0.999
```

##### Complete timeseries 
to identify any missing datetimes from the dataframe

```{r checktimefc1_rw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_rw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```

```{r chktempfc1_rw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#logger downloads recorded on 8/5, 8/12 and 9/15/2020
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw1_20a, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}


#Raw pressure plot
#DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')

DyRawPressure(df=stage_well,threshold = 0.05)
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw1_20b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.', abbr, ': Raw atms data from lw1', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep',sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_rw1_20}

bad_id_fc1_well20 <-  c(1031, 2032:2036)  # Aug 5 and 12 logger download were the only were values changed by 5% or more

vert_correction_fc1_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_rw1_20, include=FALSE}  
bad_id <- bad_id_fc1_well20
vert_correction <- vert_correction_fc1_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_rw1_20}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))
```

Plot adjusted values only:

```{r plot5fc1_rw1_20, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_rw1_20}

manMeas<- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_rw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_rw1_20,, fig.align = "center", fig.cap = "Figure4.2020.FC1.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset)

```

##### Manual measurements

```{r plot7fc1_rw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_rw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_rw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1rw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc1_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc1_rw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_rw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

```{r chktempfc1_rw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw2_20a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.', abbr, ': Raw atms data from lw1', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep',sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw2_20b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.', abbr, ': Raw atms data from lw1', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep',sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_rw2_20}

bad_id_fc1_well20 <-  c(0:1)

vert_correction_fc1_well20<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_rw2_20, include=FALSE}  
bad_id <- bad_id_fc1_well20
vert_correction <- vert_correction_fc1_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_rw2_20}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_rw2_20, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=40){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(-10, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_rw2_20}

# load manual measurements
manMeas<- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```


```{r depthoffsetfc1_rw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 
```{r plot6fc1_rw2_20,, fig.align = "center", fig.cap = "Figure4.2202.FC1.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc1_rw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```


```{r plot8fc1_rw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_rw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1rw2_20 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

### Fool2 {.tabset .tabset-fade}

```{r importfc2_20, include=FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2020
watershed<- 'fool'
site <- 'fc2'
cap.site.label <- 'Fool 2'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

Subset based on logger location within the transect

```{r dfsplit_fc2_20}
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_atms20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 
ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  #rowid_to_column(var='ID') %>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_atms20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```

```{r chktempfc2_atms20, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE}

#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_atms20, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_atms20}

bad_id_fc2_atms20 <-  c(0)

vert_correction_fc2_atms20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_atms20, include=FALSE}  
bad_id <- bad_id_fc2_atms20
vert_correction <- vert_correction_fc2_atms20
```

4) Vertical adjustments

```{r vertcorrectfc2_atms20}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc2_20, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc2atms_20}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2atms_20 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatfc2_lw1_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc2_lw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_lw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

 
```{r chktempfc2_lw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw1 (55442:55497, 64922:64937, 69922:69942, 80107:80137, 85607:85602, 90797:90822, 90522:90543)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_lw1_20}

bad_id_fc2_well20 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

vert_correction_fc2_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_lw1_20, include=FALSE}  
bad_id <- bad_id_fc2_well20
vert_correction <- vert_correction_fc2_well20
```

3) Vertical adjustments

```{r vertcorrectfc2_lw1_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc2_lw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_lw1_20}
# load manual measurements
manMeas<- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_lw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_lw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc2.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_lw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_lw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_lw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2lw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc2_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc2_lw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_lw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```

 
```{r chktempfc2_lw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw2 (64923:64968, 69923:69948, 80098:80148, 85613:85643, 90693:90718, 90798:90813, 95023:95074)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}
#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_lw2_20}

bad_id_fc2_well20 <-  c(0:1)

vert_correction_fc2_well20 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_lw2_20, include=FALSE}  
bad_id <- bad_id_fc2_well20
vert_correction <- vert_correction_fc2_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_lw2_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot5fc2_lw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_lw2_20}
# load manual measurements
manMeas<- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_lw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_lw2_20,, fig.align = "center", fig.cap = "Figure4.2020.fc2.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_lw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_lw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_lw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2lw2_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc2_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)
```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_rw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_rw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```
 
```{r chktempfc2_rw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_rw1_20}

bad_id_fc2_well20 <-  c(0:1)

vert_correction_fc2_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_rw1_20, include=FALSE}  
bad_id <- bad_id_fc2_well20
vert_correction <- vert_correction_fc2_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_rw1_20}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc2_rw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_rw1_20}
# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_rw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_rw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc2.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_rw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_rw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_rw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2rw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc2_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)
```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_rw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_rw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

 
```{r chktempfc2_rw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_rw2_20}

bad_id_fc2_well20 <-  c(0:1)

vert_correction_fc2_well20<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_rw2_20, include=FALSE}  
bad_id <- bad_id_fc2_well20
vert_correction <- vert_correction_fc2_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_rw2_20}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot5fc2_rw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=40){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(-10, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_rw2_20}
# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_rw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_rw2_20,, fig.align = "center", fig.cap = "Figure4.2202.fc2.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc2_rw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_rw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_rw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2rw2_20 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

### Fool3 {.tabset .tabset-fade}

```{r importfc3_20, include=FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2020
watershed<- 'fool'
site <- 'fc3'
cap.site.label <- 'Fool 3'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc3_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

```{r dfsplit_fc3_20}
# Subset based on logger location within the transect
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc3_atms20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  rowid_to_column(var='ID') %>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc3_atms20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```
 
```{r chktempfc3_atms20, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE}

#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_atms20, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc3_atms20}

bad_id_fc3_atms20 <-  c(0)

vert_correction_fc3_atms20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc3_atms20, include=FALSE}  
bad_id <- bad_id_fc3_atms20
vert_correction <- vert_correction_fc3_atms20
```

4) Vertical adjustments

```{r vertcorrectfc3_atms20}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc3_20, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc3atms_20}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc3atms_20 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatlw1_fc3_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc3_lw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```


```{r checktime2fc3_lw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

 
```{r chktempfc3_lw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw1 (55442:55497, 64922:64937, 69922:69942, 80107:80137, 85607:85602, 90797:90822, 90522:90543)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_lw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_lw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc3_lw1_20}

bad_id_fc3_well20 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

vert_correction_fc3_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc3_lw1_20, include=FALSE}  
bad_id <- bad_id_fc3_well20
vert_correction <- vert_correction_fc3_well20
```

3) Vertical adjustments

```{r vertcorrectfc3_lw1_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc3_lw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc3_lw1_20}
# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc3' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc3_lw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc3_lw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc3.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc3_lw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc3_lw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc3_lw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc3lw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc3_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc3_lw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc3_lw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```

 
```{r chktempfc3_lw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw2 (64923:64968, 69923:69948, 80098:80148, 85613:85643, 90693:90718, 90798:90813, 95023:95074)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_lw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_lw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```


2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc3_lw2_20}

bad_id_fc3_well20 <-  c(0:1)

vert_correction_fc3_well20 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc3_lw2_20, include=FALSE}  
bad_id <- bad_id_fc3_well20
vert_correction <- vert_correction_fc3_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc3_lw2_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc3_lw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc3_lw2_20}
# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc3' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc3_lw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc3_lw2_20,, fig.align = "center", fig.cap = "Figure4.2020.fc3.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc3_lw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc3_lw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc3_lw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc3lw2_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc3_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Complete timeseries 
to identify any missing datetimes from the dataframe

```{r checktimefc3_rw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc3_rw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```

 
```{r chktempfc3_rw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_rw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_rw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc3_rw1_20}

bad_id_fc3_well20 <-  c(0:1)

vert_correction_fc3_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc3_rw1_20, include=FALSE}  
bad_id <- bad_id_fc3_well20
vert_correction <- vert_correction_fc3_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc3_rw1_20}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc3_rw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc3_rw1_20}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc3' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc3_rw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc3_rw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc3.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage +  manual_offset)

```

##### Manual measurements

```{r plot7fc3_rw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc3_rw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc3_rw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc3rw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc3_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc3_rw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc3_rw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

 
```{r chktempfc3_rw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_rw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc3_rw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc3_rw2_20}

bad_id_fc3_well20 <-  c(0:1)

vert_correction_fc3_well20<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc3_rw2_20, include=FALSE}  
bad_id <- bad_id_fc3_well20
vert_correction <- vert_correction_fc3_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc3_rw2_20}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc3_rw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=40){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(-10, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```


4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc3_rw2_20}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc3' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```


```{r depthoffsetfc3_rw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 
```{r plot6fc3_rw2_20,, fig.align = "center", fig.cap = "Figure4.2202.fc3.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc3_rw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```


```{r plot8fc3_rw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc3_rw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc3rw2_20 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

### Fool4 {.tabset .tabset-fade}

```{r}
opn_as_dflist <- function(interfiles, year, watershed, site) {
   file_path <- paste(getwd(), interfiles, year, watershed, site, sep='/')
   path_list <- paste(file_path, list.files(file_path), sep= '/')
   data <- lapply(path_list, function(x) {
      dat <- read.table(x, skip = 1, header = TRUE, sep = ",", row.names = NULL, as.is = TRUE)

      dat <- dat[, 1:3]
      colnames(dat) <- c('datetime', 'pressure_kPa', 'temperature_C')
      # for each item in path list, grab the cap_rod number
      dat$logger_no <- as.factor(unlist(strsplit(x, "_"))[8])
      dat$trans_loc <- as.factor(unlist(strsplit(x, "_"))[7])
      return(dat)
   })
}
```

```{r importfc4_20, include=FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2020
watershed<- 'fool'
site <- 'fc4'
cap.site.label <- 'Fool 4'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc4_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

Subset based on logger location within the transect

```{r dfsplit_fc4_20}
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc4_atms20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  rowid_to_column(var='ID') %>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc4_atms20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```
 
```{r chktempfc4_atms20, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE}
#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_atms20, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc4_atms20}

bad_id_fc4_atms20 <-  c(0)

vert_correction_fc4_atms20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc4_atms20, include=FALSE}  
bad_id <- bad_id_fc4_atms20
vert_correction <- vert_correction_fc4_atms20
```

4) Vertical adjustments

```{r vertcorrectfc4_atms20}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc4_20, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc4atms_20}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc4atms_20 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatlw1_fc4_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)
```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc4_lw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 
ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc4_lw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

 
```{r chktempfc4_lw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw1 (55442:55497, 64922:64937, 69922:69942, 80107:80137, 85607:85602, 90797:90822, 90522:90543)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_lw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_lw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc4_lw1_20}

bad_id_fc4_well20 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

vert_correction_fc4_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc4_lw1_20, include=FALSE}  
bad_id <- bad_id_fc4_well20
vert_correction <- vert_correction_fc4_well20
```

3) Vertical adjustments

```{r vertcorrectfc4_lw1_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc4_lw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc4_lw1_20}

# load manual measurements
manMeas<- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc4' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc4_lw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc4_lw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc4.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc4_lw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc4_lw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc4_lw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc4lw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc4_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc4_lw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc4_lw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```

 
```{r chktempfc4_lw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw2 (64923:64968, 69923:69948, 80098:80148, 85613:85643, 90693:90718, 90798:90813, 95023:95074)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_lw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_lw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc4_lw2_20}

bad_id_fc4_well20 <-  c(0:1)

vert_correction_fc4_well20 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc4_lw2_20, include=FALSE}  
bad_id <- bad_id_fc4_well20
vert_correction <- vert_correction_fc4_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc4_lw2_20}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot5fc4_lw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc4_lw2_20}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc4' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc4_lw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc4_lw2_20,, fig.align = "center", fig.cap = "Figure4.2020.fc4.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc4_lw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc4_lw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc4_lw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc4lw2_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc4_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc4_rw1_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc4_rw1_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```

 
```{r chktempfc4_rw1_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_rw1_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_rw1_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc4_rw1_20}

bad_id_fc4_well20 <-  c(0:1)

vert_correction_fc4_well20<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc4_rw1_20, include=FALSE}  
bad_id <- bad_id_fc4_well20
vert_correction <- vert_correction_fc4_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc4_rw1_20}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc4_rw1_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc4_rw1_20}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc4' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc4_rw1_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc4_rw1_20,, fig.align = "center", fig.cap = "Figure4.2020.fc4.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc4_rw1_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc4_rw1_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc4_rw1_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc4rw1_20 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc4_20}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  rowid_to_column(var='ID') %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)
```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc4_rw2_20, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc4_rw2_20, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

 
```{r chktempfc4_rw2_20, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_rw2_20a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc4_rw2_20b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc4_rw2_20}

bad_id_fc4_well20 <-  c(0:1)

vert_correction_fc4_well20<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc4_rw2_20, include=FALSE}  
bad_id <- bad_id_fc4_well20
vert_correction <- vert_correction_fc4_well20

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc4_rw2_20}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot5fc4_rw2_20, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=40){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(-10, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc4_rw2_20}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc4' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc4_rw2_20}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc4_rw2_20,, fig.align = "center", fig.cap = "Figure4.2202.fc4.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc4_rw2_20, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc4_rw2_20, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc4_rw2_20}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc4rw2_20 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

## 2021 {.tabset .tabset-fade}

### Fool1 {.tabset .tabset-fade}

```{r importfc1_21, include=FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2021
watershed<- 'fool'
site <- 'fc1'
cap.site.label <- 'Fool 1'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc1_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

```{r dfsplit_fc1_21}
# Subset based on logger location within the transect
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc1_atms21, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_atms21, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```
 
```{r chktempfc1_atms21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_atms21, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.atms: Raw atmospheric data from ', cap.site.label, ' ', year, ', with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}
#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_atms21}

bad_id_fc1_atms21 <-  c(0)

vert_correction_fc1_atms21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_atms21, include=FALSE}  
bad_id <- bad_id_fc1_atms21
vert_correction <- vert_correction_fc1_atms21
```

4) Vertical adjustments

```{r vertcorrectfc1_atms21}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc1_21, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc1atms_21}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1atms_21 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatlw1_fc1_21}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc1_lw1_21), echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```


```{r checktime2fc1_lw1_21, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

 
```{r chktempfc1_lw1_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}


#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw1 (55442:55497, 64922:64937, 69922:69942, 80107:80137, 85607:85602, 90797:90822, 90522:90543)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw1_21a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.lw1: Raw stage data from ', cap.site.label, ' ', year, ' left riparian well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw1_21b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.lw1: Raw stage data from ', cap.site.label, ' ', year, ' left riparian well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}
#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_lw1_21}

bad_id_fc1_well21 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

vert_correction_fc1_well21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_lw1_21, include=FALSE}  
bad_id <- bad_id_fc1_well21
vert_correction <- vert_correction_fc1_well21
```

3) Vertical adjustments

```{r vertcorrectfc1_lw1_21}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_lw1_21, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_lw1_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_lw1_21, eval = FALSE}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_lw1_21,, fig.align = "center", fig.cap = "Figure4.2021.FC1.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc1_lw1_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_lw1_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}

#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_lw1_21,eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc1lw1_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc1_21}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 

```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc1_lw2_21, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_lw2_21, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```

 
```{r chktempfc1_lw2_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw2 (64923:64968, 69923:69948, 80098:80148, 85613:85643, 90693:90718, 90798:90813, 95023:95074)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw2_21a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.lw2: Raw pressure data from ', cap.site.label, ' ', year, ' left upslope well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_lw2_21b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.lw2: Raw stage data from ', cap.site.label, ' ', year, ' left upslope well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}
#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```


2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_lw2_21}

bad_id_fc1_well21 <-  c(0:1)

vert_correction_fc1_well21 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_lw2_21, include=FALSE}  
bad_id <- bad_id_fc1_well21
vert_correction <- vert_correction_fc1_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_lw2_21}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_lw2_21, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_lw2_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_lw2_21, eval = FALSE}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_lw2_21,, fig.align = "center", fig.cap = "Figure4.2021.FC1.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc1_lw2_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_lw2_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_lw2_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc1lw2_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc1_21, eval = FALSE}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6) 
```

##### Complete timeseries 
to identify any missing datetimes from the dataframe

```{r checktimefc1_rw1_21, echo=FALSE, results = 'asis', eval = FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_rw1_21, echo=FALSE, results = 'asis', eval = FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo = FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```

 
```{r chktempfc1_rw1_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE, eval = FALSE}


#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw1_21a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.rw1: Raw pressure data from ', cap.site.label, ' ', year, ' right riparian well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval = FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw1_21b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.rw1: Raw stage data from ', cap.site.label, ' ', year, ' right riparian well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval = FALSE}
#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_rw1_21, eval = FALSE}

bad_id_fc1_well21 <-  c(0:1)

vert_correction_fc1_well21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_rw1_21, include=FALSE, eval = FALSE}  
bad_id <- bad_id_fc1_well21
vert_correction <- vert_correction_fc1_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_rw1_21, eval = FALSE}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_rw1_21, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE, eval = FALSE}

dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_rw1_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_rw1_21, eval = FALSE}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_rw1_21,, fig.align = "center", fig.cap = "Figure4.2021.FC1.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc1_rw1_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_rw1_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_rw1_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc1rw1_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc1_21, eval = FALSE}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  rowid_to_column(var='ID') %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc1_rw2_21, echo=FALSE, results = 'asis', eval = FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_rw2_21, echo=FALSE, results = 'asis', eval = FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo = FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

 
```{r chktempfc1_rw2_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE, eval = FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw2_21a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.rw2: Raw stage data from ', cap.site.label, ' ', year, ' right upslope well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval = FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_rw2_21b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.rw2: Raw stage data from ', cap.site.label, ' ', year, ' right upslope well, with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval = FALSE}
#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_rw2_21, eval = FALSE}

bad_id_fc1_well21 <-  c(0:1)

vert_correction_fc1_well21<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_rw2_21, include=FALSE, eval = FALSE}  
bad_id <- bad_id_fc1_well21
vert_correction <- vert_correction_fc1_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc1_rw2_21, eval = FALSE}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot5fc1_rw2_21, fig.align = "center", fig.cap = "Figure 3.a: Same as 3 but limited to adjusted values only.", echo=FALSE}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_rw2_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc1' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```


```{r depthoffsetfc1_rw2_21, eval = FALSE}

#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 
```{r plot6fc1_rw2_21,, fig.align = "center", fig.cap = "Figure4.2021.FC1.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc1_rw2_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```


```{r plot8fc1_rw2_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_rw2_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc1rw2_21 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

### Fool2 {.tabset .tabset-fade}

```{r importfc2_21, include=FALSE, eval = FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2021
watershed<- 'fool'
site <- 'fc2'
cap.site.label <- 'Fool 2'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc2_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE, eval = FALSE}
#quick plot of stage
#plotdf <- press_raw[press_raw$trans_loc == 'atms' | press_raw$trans_loc == 'lw1' | press_raw$trans_loc == 'lw1AbsPres',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

Subset based on logger location within the transect

```{r dfsplit_fc2_21, eval = FALSE}
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_atms21, echo=FALSE, results = 'asis', eval = FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_atms21, echo=FALSE, results = 'asis', eval = FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo = FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```
 
```{r chktempfc2_atms21, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE, eval = FALSE}
#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_atms21, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE, eval = FALSE}

#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_atms21, eval = FALSE}

bad_id_fc2_atms21 <-  c(0)

vert_correction_fc2_atms21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_atms21, include=FALSE, eval = FALSE}  
bad_id <- bad_id_fc2_atms21
vert_correction <- vert_correction_fc2_atms21
```

4) Vertical adjustments

```{r vertcorrectfc2_atms21, eval = FALSE}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc2_21, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE, eval = FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc2atms_21, eval = FALSE}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

Generate simple df for among year plots

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc2atms_21 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### LW1 {.tabset .tabset-fade}

```{r formatfc2_lw1_21, eval = FALSE}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc2_lw1_21, echo=FALSE, results = 'asis', eval = FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_lw1_21, echo=FALSE, results = 'asis', eval = FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw1'
posit_nm <- 'well'
long_nm <- 'left ripaian well'
```

 
```{r chktempfc2_lw1_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE, eval = FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw1 (55442:55497, 64922:64937, 69922:69942, 80107:80137, 85607:85602, 90797:90822, 90522:90543)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw1_21a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE, eval = FALSE}

#Raw pressure plot
DyRawPress(df=stage_well, threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw1_21b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE, eval = FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_lw1_21, eval = FALSE}

bad_id_fc2_well21 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

vert_correction_fc2_well21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_lw1_21, include=FALSE, eval = FALSE}  
bad_id <- bad_id_fc2_well21
vert_correction <- vert_correction_fc2_well21
```

3) Vertical adjustments

```{r vertcorrectfc2_lw1_21, eval = FALSE}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot4fc2_lw1_21, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, " ", long_nm, " ", "after the first round of adjustments, which include eliminating points where HOBO was out of the stream for periodic downloading and eliminating points collected after HOBO was removed from the stream. Both raw and adjusted values are shown", sep = ''), echo=FALSE, eval = FALSE}

dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_lw1_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'lw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_lw1_21, eval = FALSE}

#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_lw1_21,, fig.align = "center", fig.cap = "Figure4.2021.fc2.lw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_lw1_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_lw1_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}

#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_lw1_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc2lw1_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### LW2 {.tabset .tabset-fade}

```{r formatlw2_fc2_21, eval = FALSE}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_lw2, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Create complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc2_lw2_21, echo=FALSE, results = 'asis', eval = FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_lw2_21, echo=FALSE, results = 'asis', eval = FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'lw2'
posit_nm <- 'well'
long_nm <- 'left upslope well'
```

 
```{r chktempfc2_lw2_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  lw2 (64923:64968, 69923:69948, 80098:80148, 85613:85643, 90693:90718, 90798:90813, 95023:95074)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw2_21a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_lw2_21b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_lw2_21}

bad_id_fc2_well21 <-  c(0:1)

vert_correction_fc2_well21 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_lw2_21, include=FALSE}  
bad_id <- bad_id_fc2_well21
vert_correction <- vert_correction_fc2_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_lw2_21}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot5fc2_lw2_21, fig.align = "center", fig.cap = "Figure 3a: Same as 3 but limited to adjusted values only.", echo=FALSE}
dyStageAdjonly<- function(df, max=50){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_lw2_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'lw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_lw2_21}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_lw2_21,, fig.align = "center", fig.cap = "Figure4.2021.fc2.lw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_lw2_21, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_lw2_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_lw2_21}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2lw2_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW1 {.tabset .tabset-fade}

```{r formatrw1_fc2_21}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw1, mrg_press_adj, by = 'datetime') %>%
  rowid_to_column(var='ID') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_rw1_21, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_rw1_21, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw1'
posit_nm <- 'well'
long_nm <- 'right riparian well'
```

 
```{r chktempfc2_rw1_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw1_21a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}
#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw1_21b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 100)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_rw1_21}

bad_id_fc2_well21 <-  c(0:1)

vert_correction_fc2_well21<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_rw1_21, include=FALSE}  
bad_id <- bad_id_fc2_well21
vert_correction <- vert_correction_fc2_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_rw1_21}
#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot4fc2_rw1_21, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, " ", long_nm, " ", "after the first round of adjustments, which include eliminating points where HOBO was out of the stream for periodic downloading and eliminating points collected after HOBO was removed from the stream. Both raw and adjusted values are shown", sep = ''), echo=FALSE}

dyStageAdjonly<- function(df, max=60){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(30, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_rw1_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'rw1' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_rw1_21, eval = FALSE}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_min(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_rw1_21,, fig.align = "center", fig.cap = "Figure4.2021.fc2.rw1: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc2_rw1_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_rw1_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}

#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_rw1_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r, eval = FALSE}
# Simple df of adjusted values for stacked plot (see below)
simplefc2rw1_21 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```

#### RW2 {.tabset .tabset-fade}

```{r formatrw2_fc2_21}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])
  
stage_well <- merge(press_raw_rw2, mrg_press_adj, by = 'datetime') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  rowid_to_column(var='ID') %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)
```

##### Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc2_rw2_21, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_well$datetime[2] - stage_well$datetime[1]

##round datetime to nearest whole interval
stage_well <- stage_well%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_well$datetime[1], stage_well$datetime[length(stage_well$datetime)], by=ts_interval))
stage_well <- full_join(full_ts, stage_well, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_well, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc2_rw2_21, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'rw2'
posit_nm <- 'well'
long_nm <- 'right upslope well'
```

 
```{r chktempfc2_rw2_21, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, abbr, ': Air temperature data captured by the HOBO water level logger monitoring pressure in the ', long_nm, '(', abbr, ') ', cap.site.label, ' - ', year, '.', sep = ''), echo=FALSE, eval = FALSE}

#check temp data
DyTemp(df = stage_well, airtemp = 'n') #check function if have logger_temp, default is 'y'

#  rw2 (9933:9937, 11085:11093, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)
```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw2_21a, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw pressure plot
DyRawPress(df=stage_well,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc2_rw2_21b, fig.align = "center", fig.cap = paste("Figure 2. ", year, " - ", cap.site.label, ".", abbr, ": Raw atms data from ", cap.site.label, " ", year, " with flags where average stage changes by more than 5% in a single timestep", sep = ''), echo=FALSE}

#Raw stage plot
DyRawStage(df=stage_well, threshold = 0.05, flag='TRUE', max = 10)
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_rw2_21}

bad_id_fc2_well21 <-  c(0:1)

vert_correction_fc2_well21<- data.frame(ID = c(0:1), offset=c(0.00))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc2_rw2_21, include=FALSE}  
bad_id <- bad_id_fc2_well21
vert_correction <- vert_correction_fc2_well21

#bad_id <- 0
```

3) Vertical adjustments

```{r vertcorrectfc2_rw2_21}
#function to make vertical correction and interpolate between missing values 
#stage_adj<- AdjStage(df=stage_well, maxgap=8) %>%
#    mutate(watershed = watershed) %>%
 #   mutate(site = site) %>%
#    filter(ID > 3) %>% # beginning of data
#    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
#    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)
```

Plot adjusted values only:

```{r plot4fc2_rw2_21, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, " ", long_nm, " ", "after the first round of adjustments, which include eliminating points where HOBO was out of the stream for periodic downloading and eliminating points collected after HOBO was removed from the stream. Both raw and adjusted values are shown", sep = ''), echo=FALSE}

dyStageAdjonly<- function(df, max=40){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='cm',valueRange = c(-10, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc2_rw2_21, eval = FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
  mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
  mutate(water_depth = dep_to_bed-dep_to_water) %>% 
  filter(., site == 'fc2' & position == 'rw2' )
  
cols <- c('watershed', 'site', 'position', 'tech')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc2_rw2_21, eval = FALSE}

#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(dep_to_bed,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - dep_to_water)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc2_rw2_21,, fig.align = "center", fig.cap = "Figure4.2021.fc2.rw2: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe.", eval = FALSE}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 5.5

stage_adj[stage_adj$ID>15483,]$adj_stage <- stage_adj[stage_adj$ID>15483,]$adj_stage-manual_offset

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage)

```

##### Manual measurements

```{r plot7fc2_rw2_21, fig.align = "center", eval = FALSE}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc2_rw2_21, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)", eval = FALSE}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc2_rw2_21, eval = FALSE}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc2rw2_21 <- stage_adj %>%
  select(datetime, adj_stage, site) %>%
  drop_na()
```

## 2022 {.tabset .tabset-fade}

### Fool1 {.tabset .tabset-fade}

```{r importfc1_22, include=FALSE}
interfiles <- 'formatted_data/stage_pressure'
year <- 2022
watershed<- 'fool'
site <- 'fc3'
cap.site.label <- 'Fool 1'

press_raw <- concat(opn_as_dflist(interfiles, year, watershed, site))
```

Quick raw plot of point data

```{r plot1fc1_22, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.all: Raw data for all HOBO water level loggers in the ', cap.site.label, ' transect - ', year, '.', sep =''), echo=FALSE}
#quick plot of stage
#stage_raw[stage_raw$trans_loc == 'atms',]

ggplot(press_raw, aes(datetime, pressure_kPa, color = trans_loc))+
  geom_line() + 
  ggtitle(paste(watershed, year, sep = ' '))

```

Subset based on logger location within the transect

```{r dfsplit_fc2_22}
press_raw_list <- split(press_raw, press_raw$trans_loc)

# Write out single data frames
for (i in seq(press_raw_list))
  assign(paste0('press_raw_', press_raw_list[[i]]$trans_loc[i]), press_raw_list[[i]])
```

#### Atmospheric {.tabset .tabset-fade}

##### Complete timeseries
Create complete timeseries to identify any missing datetimes from the dataframe

```{r checktimefc1_atms22, echo=FALSE, results = 'asis'}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- press_raw_atms$datetime[2] - press_raw_atms$datetime[1]

##round datetime to nearest whole interval
press_raw_atms <- press_raw_atms%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(press_raw_atms$datetime[1], press_raw_atms$datetime[length(press_raw_atms$datetime)], by=ts_interval))
press_raw_atms <- full_join(full_ts,press_raw_atms, by='datetime')

#identify missing timesteps:
miss_ts <- filter(press_raw_atms, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_atms22, echo=FALSE, results = 'asis'}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
Keep in mind that the the factory calibrated ranges are:
0째 to 40째C (32째 to 104째F)

```{r, echo=FALSE}
# Figure caption labels
abbr <- 'atms'
posit_nm <- 'atmospheric'
long_nm <- 'atmospheric'
```
 
```{r chktempfc1_atms22, fig.align = "center", fig.cap = paste("Figure 1.", year, " - ", cap.site.label, ".", abbr, ": Air temperature data captured by the HOBO water level logger monitoring ", posit_nm, " pressure in ", cap.site.label, " - ", year, ".", sep = ''), echo=FALSE}

#check temp data
DyTemp(df = press_raw_atms, airtemp = 'n') #check function if have logger_temp, default is 'y'

# Even with atmospheric HOBO, it appears that the HOBO logger does not record temps below 0C. 
```

2) Plot raw data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_atms22, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.atms: Raw stage data from ', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE}
#Raw stage plot
DyRawPress(df=press_raw_atms,threshold = 0.05, flag='TRUE')
```

3) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc2_atms22}

bad_id_fc1_atms22 <-  c(0)

vert_correction_fc1_atms22<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_atms22, include=FALSE}  
bad_id <- bad_id_fc1_atms22
vert_correction <- vert_correction_fc1_atms22
```

4) Vertical adjustments

```{r vertcorrectfc1_atms22}

#function to make vertical correction and interpolate between missing values 
press_adj<- AdjPress(df=press_raw_atms, maxgap=8)%>%
    mutate(watershed = watershed)%>%
    mutate(site = site)%>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < -65, 'Below Logger',
    ifelse(pressure_kPa > 75, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

##### Plot adjusted pressure

```{r plot4fc1_22, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, posit_nm, " data."), echo=FALSE}

dyPressAdj(df=press_adj)

```

##### Export

```{r savefc1atms_22}
#stage_final <- stage_adj %>%
press_final <- press_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
        #dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
      dplyr::select(watershed, site, date, time, adj_press, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(press_final, file=paste0(file_path, '/',site, 'atms_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1atms_22 <- press_adj %>%
  select(datetime, adj_press, site) %>%
  drop_na()
```

#### Stream {.tabset .tabset-fade}

```{r formatstream_fc2_22, eval=FALSE}
mrg_press_adj <- as.data.frame(press_adj[,c('datetime','adj_press')])

ts_interval<- press_raw_stream$datetime[2] - press_raw_stream$datetime[1]
##round datetime to nearest whole interval
press_raw_stream <- press_raw_stream%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))
  
stage_stream <- merge(press_raw_stream, mrg_press_adj, by = 'datetime') %>%
  mutate(adj_h2opressure = pressure_kPa - adj_press) %>%
  mutate(hobo_wtr_depth_cm = (adj_h2opressure*9.98) + 1.6)

```

##### Complete timeseries 
Identify any missing datetimes from the dataframe

```{r checktimefc1_stream22, echo=FALSE, results = 'asis', eval=FALSE}
#check if collection interval is consistent in dataset. Function as written only handles one interval but can be modified if interval was changed. 

ts_interval<- stage_stream$datetime[2] - stage_stream$datetime[1]

##round datetime to nearest whole interval
stage_stream <- stage_stream%>%
  mutate(datetime = round_date(datetime, as.period(ts_interval)))

#create full timeseries 
full_ts <- tibble(datetime=seq.POSIXt(stage_stream$datetime[1], stage_stream$datetime[length(stage_stream$datetime)], by=ts_interval))
stage_stream <- full_join(full_ts, stage_stream, by='datetime')

#identify missing timesteps:
miss_ts <- filter(stage_stream, is.na(pressure_kPa)) %>%
  pull(datetime)
```

```{r checktime2fc1_stream22, echo=FALSE, results = 'asis', eval=FALSE}
cat(paste0(
  "- `", 'The number of missing timesteps is ', length(miss_ts), "`", sep = "\n"))

```

##### Check raw pressure
1) Plot temperature for quick checks
 
```{r chktempfc1_stream22, fig.align = "center", fig.cap = paste('Figure 1. ', year, ' - ', cap.site.label, '.', abbr, ' : Air temperature data captured by the HOBO water level logger monitoring pressure in the stream ', cap.site.label, ' - ', year, '.', sep = ' '), echo=FALSE, eval=FALSE}

#check temp data
DyTemp(df = stage_stream, airtemp = 'n') #check function if have logger_temp, default is 'y'

```

2) Plot raw pressure data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_stream22a, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.stream: Raw pressure data from ', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval=FALSE}

#Raw stage plot
DyRawPress(df=stage_stream,threshold = 0.05, flag='TRUE')
```

##### Clean raw stage
1) Plot raw water depth data with flag if raw level changes by more than 5%.

```{r plantflagsfc1_stream22b, fig.align = "center", fig.cap = paste('Figure 2. ', year, ' - ', cap.site.label, '.stream: Raw stage data from ', cap.site.label, ' ', year, ' with flags where average stage changes by more than 5% in a single timestep'), echo=FALSE, eval=FALSE}
#Raw stage plot
DyRawStage(df=stage_stream, threshold = 0.05, flag='TRUE')
```

2) Manually identify points to be removed or corrected using the flagged plot

```{r badidfc1_stream22}

bad_id_fc3_stream22 <-  c(0)

vert_correction_fc3_stream22<- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```

```{r badid2fc1_stream22, include=FALSE}  
bad_id <- bad_id_fc1_stream22
vert_correction <- vert_correction_fc1_stream22
```

3) Vertical adjustments

```{r vertcorrectfc1_stream22}

#function to make vertical correction and interpolate between missing values 
stage_adj<- AdjStage(df=stage_stream, maxgap=8) %>%
    mutate(watershed = watershed) %>%
    mutate(site = site) %>%
    filter(ID > 3) %>% # beginning of data
    mutate(level_flag = ifelse(pressure_kPa < 0, 'Below Logger',
    ifelse(pressure_kPa > 145, 'Over Logger', 'In Range')))

#stageAdj<- AdjStage(maxgap=30)

```

Plot adjusted values only:

```{r plot4fc1_stream_22, fig.align = "center", fig.cap = paste("Figure 3.", year, " - ", cap.site.label, ".", abbr, ": Pressure data from ", cap.site.label, " ", long_nm, " ", "after the first round of adjustments, which include eliminating points where HOBO was out of the stream for periodic downloading and eliminating points collected after HOBO was removed from the stream. Both raw and adjusted values are shown", sep = ''), echo=FALSE}

dyStageAdjonly<- function(df, max=20){
      tsStageAdj<- xts(dplyr::select(df, datetime, adj_stage, ID), order.by=df$datetime)
      dygraph(tsStageAdj, main = site) %>% 
            dyAxis('y',label='kPa',valueRange = c(0, max))%>%
            dyAxis('y2',label='ID',independentTicks=T)%>%
            dySeries('ID',axis='y2')%>%
            dyRangeSelector() %>%
            #dyHighlight(highlightCircleSize = 4, 
            #        highlightSeriesBackgroundAlpha = 0.2,
            #       hideOnMouseOut = TRUE)%>%
            dyOptions(drawPoints = FALSE, pointSize = 2)%>%
            dyLegend(show = "always")
}

dyStageAdjonly(df=stage_adj)
```

4) Check manual measurements - stream measurements performed from caprod post

```{r importmanualfc1_stream_22, eval=FALSE}

# load manual measurements
manMeas <- manualMeas %>%
      #timezone set to MST, change if loggers used MDT/MST
      mutate(datetime = round_date(mdy_hm(datetime, tz='America/Phoenix'),'30 minutes')) %>% 
      mutate(water_depth = to_bed_cm - to_water_surface_cm) %>%
      filter(., site == 'fc1')

cols <- c('watershed', 'site')
manMeas[cols] <- lapply(manMeas[cols], factor) 
```

```{r depthoffsetfc1_stream_22}
#choose a static depth to bed value. Here we are using a mean of manual bed measurements from the top of the caprod post
stat_to_bed <- manMeas%>%
  summarize(mean_dep_to_bed = mean(to_bed_cm,na.rm=T))%>%
  pull(mean_dep_to_bed)

manMeas_fil <- manMeas %>%
      dplyr::rename(., wtr_depth_not_static = water_depth) %>%
      mutate(man_wtr_dep_static = stat_to_bed - to_water_surface_cm)
### 10 to convert mm to cm

depth_offset <- manMeas_fil %>%
  slice_max(datetime) %>%
  left_join(stage_adj %>%
              dplyr::select(datetime, adj_stage)) %>%
  mutate(depth_offset = man_wtr_dep_static - adj_stage)%>%
  pull(depth_offset)
```

Manual adjustments: 

```{r plot6fc1_stream_22,, fig.align = "center", fig.cap = "Figure4.2022.FC1.stream: Adjusted pressure data from Fool 1 stream channel which includes a manual offset that adjusts all values in the dataframe."}
#start with 0 value, change if plots below suggest need for manual adjustment change value. 
manual_offset <- 0

stage_adj <- stage_adj%>%
  mutate(wtr_depth = adj_stage + manual_offset )

```

##### Manual measurements

```{r plot7fc1_stream_22, fig.align = "center"}
#plot difference between measured water depth and manual depth measurement
stage_adj <- as.data.frame(stage_adj)
stageAdj.man<- dplyr::left_join(manMeas_fil, stage_adj, by = 'datetime') %>%
      mutate(diff = man_wtr_dep_static-wtr_depth)

ggplot(stageAdj.man, aes(datetime, diff))+
  geom_point(size=3)+
  theme_minimal()
```

```{r plot8fc1_stream_22, fig.align = "center", fig.cap = "Figure 2.1.7: Adjusted stage data with manual measurements (points)"}
#plot water level time series with manual measurements as points
stage_check_plot<- stage_adj%>%
  dplyr::left_join(.,manMeas_fil, by = 'datetime') %>%
  ggplot(aes(datetime,wtr_depth))+
    geom_line()+
    geom_point(aes(datetime, man_wtr_dep_static),size=3,col='red')

ggplotly(stage_check_plot)
```

##### Export

```{r savefc1_stream_22}
stage_final <- stage_adj %>%
      drop_na() %>%
      mutate(date = lubridate::date(datetime)) %>%
      mutate(time = format(datetime, format = "%H:%M")) %>%
      dplyr::select(watershed, site, date, time, wtr_depth, level_flag) 
    
loc_site<- paste(watershed,site, sep='_') 

interfiles <- 'clean_data/stage_pressure'
file_path <- paste(getwd(), interfiles,year,watershed,site, sep='/')
#saveRDS(stage_final, file=paste0('data/cln/wtr_lvl_',loc_site,'.csv'))
write_csv(stage_final, file=paste0(file_path, '/',site, '_clean.csv'))

```

```{r}
# Simple df of adjusted values for stacked plot (see below)
simplefc1stream_22 <- stage_adj %>%
  select(datetime, wtr_depth, site) %>%
  drop_na()
```


## 2022adjustments

```{r badidfc1_lw2_22}

bad_id_fc1_well22 <-  c(64923:64968, 69923:69993, 80098:80148, 85603:85728, 90678:90798, 90798:90813, 90843:90928, 95013:95164 )

vert_correction_fc1_well22 <- data.frame(ID = c(0:1), offset=c(0))%>%
  mutate(cumOffset = cumsum(offset))
```


```{r badidfc1_rw2_22}

bad_id_fc1_well22 <-  c(9933:9937, 11085:11093, 12983:12985, 13981:13990, 16019:16031, 17119:17126, 18136:18166, 19001:19010)

#vert_correction_fc1_well22<- data.frame(ID = c(11505:15482), offset=c(0.00165))%>%
#  mutate(cumOffset = cumsum(offset))
```

```{r badidfc1_rw1_22}

bad_id_fc1_well22 <-  c(46979:49719, 55439:55479, 64919:64954, 69914:69949, 80104:80159, 85604:85619, 90689:90729, 90799:90834, 95014:95063)

#vert_correction_fc1_well22<- data.frame(ID = c(0:1), offset=c(0))%>%
#  mutate(cumOffset = cumsum(offset))
```

```{r badidfc1_lw1_22}

bad_id_fc1_well22 <-  c(55442:55497, 64917:64962, 69922:69942, 80107:80137, 85607:85642, 90672:90757, 90797:90822, 90522:90543, 95017:95061 )

#vert_correction_fc1_well22<- data.frame(ID = c(0:1), offset=c(0))%>%
#  mutate(cumOffset = cumsum(offset))
```





